name: Gateway Tests - Complete Pipeline

on:
  # Unit tests on every commit
  push:
    branches:
      - main
      - develop
      - 'feat/gateway-*'
    paths:
      - 'src/sark/services/gateway/**'
      - 'src/sark/api/routers/gateway.py'
      - 'src/sark/models/gateway.py'
      - 'tests/**'

  # Integration tests on PR
  pull_request:
    branches:
      - main
      - develop

  # Performance tests nightly
  schedule:
    - cron: '0 2 * * *'  # 2 AM daily

  # Security scans weekly
  schedule:
    - cron: '0 3 * * 0'  # 3 AM Sunday

  # Manual trigger
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - unit
          - integration
          - performance
          - security
          - chaos

env:
  PYTHON_VERSION: '3.11'
  POETRY_VERSION: '1.6.1'

jobs:
  # ============================================================================
  # JOB 1: UNIT TESTS (Fast, run on every commit)
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'unit'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run linting
        run: |
          ruff check src/sark/ tests/
          black --check src/sark/ tests/

      - name: Run type checking
        run: |
          mypy src/sark/services/gateway/
          mypy src/sark/api/routers/gateway.py

      - name: Run unit tests
        run: |
          pytest tests/unit/ -v \
            --cov=src/sark/services/gateway \
            --cov=src/sark/api/routers/gateway \
            --cov-report=xml \
            --cov-report=term \
            --tb=short

      - name: Upload unit test coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unit-tests
          name: unit-tests

  # ============================================================================
  # JOB 2: INTEGRATION TESTS (Run on PR)
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'integration'))

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: sark
          POSTGRES_PASSWORD: sark_test_password
          POSTGRES_DB: sark_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

      opa:
        image: openpolicyagent/opa:latest
        options: >-
          --entrypoint "opa run --server --addr :8181"
        ports:
          - 8181:8181

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Setup test database
        env:
          DATABASE_URL: postgresql://sark:sark_test_password@localhost:5432/sark_test
        run: |
          alembic upgrade head || echo "No migrations yet"

      - name: Load OPA policies
        run: |
          if [ -d "opa/policies" ]; then
            for policy in opa/policies/gateway_*.rego; do
              if [ -f "$policy" ]; then
                curl -X PUT --data-binary @"$policy" \
                  http://localhost:8181/v1/policies/$(basename "$policy")
              fi
            done
          fi

      - name: Run integration tests
        env:
          DATABASE_URL: postgresql://sark:sark_test_password@localhost:5432/sark_test
          REDIS_URL: redis://localhost:6379/0
          OPA_URL: http://localhost:8181
          GATEWAY_ENABLED: true
        run: |
          pytest tests/integration/gateway/ -v \
            --cov=src/sark/services/gateway \
            --cov=src/sark/api/routers/gateway \
            --cov-report=xml \
            --cov-report=html \
            --tb=short

      - name: Upload integration test coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: integration-tests
          name: integration-tests

      - name: Upload coverage HTML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-integration
          path: htmlcov/

  # ============================================================================
  # JOB 3: PERFORMANCE TESTS (Nightly)
  # ============================================================================
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 2 * * *' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'performance'))

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: sark
          POSTGRES_PASSWORD: sark_test_password
          POSTGRES_DB: sark_test
        ports:
          - 5432:5432

      redis:
        image: redis:7
        ports:
          - 6379:6379

      opa:
        image: openpolicyagent/opa:latest
        options: >-
          --entrypoint "opa run --server --addr :8181"
        ports:
          - 8181:8181

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install pytest-benchmark

      - name: Run performance tests
        env:
          DATABASE_URL: postgresql://sark:sark_test_password@localhost:5432/sark_test
          REDIS_URL: redis://localhost:6379/0
          OPA_URL: http://localhost:8181
        run: |
          pytest tests/performance/gateway/ \
            -m performance \
            -v \
            --timeout=600 \
            --benchmark-only \
            --benchmark-autosave \
            --benchmark-compare-fail=mean:10%

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: .benchmarks/

      - name: Check performance regression
        run: |
          pytest tests/performance/gateway/ \
            --benchmark-compare=0001 \
            --benchmark-compare-fail=mean:10% || \
            echo "::warning::Performance regression detected"

  # ============================================================================
  # JOB 4: SECURITY TESTS (Weekly)
  # ============================================================================
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 3 * * 0' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'security'))

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: sark
          POSTGRES_PASSWORD: sark_test_password
          POSTGRES_DB: sark_test
        ports:
          - 5432:5432

      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"
          pip install safety bandit

      - name: Run security tests
        env:
          DATABASE_URL: postgresql://sark:sark_test_password@localhost:5432/sark_test
          REDIS_URL: redis://localhost:6379/0
        run: |
          pytest tests/security/gateway/ \
            -m security \
            -v \
            --tb=short

      - name: Run dependency security scan
        run: |
          pip-audit --desc
          safety check --json || true

      - name: Run SAST scan
        run: |
          bandit -r src/sark/services/gateway/ \
            -f json \
            -o bandit-report.json || true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json

  # ============================================================================
  # JOB 5: CHAOS TESTS (On demand or nightly)
  # ============================================================================
  chaos-tests:
    name: Chaos Engineering Tests
    runs-on: ubuntu-latest
    if: |
      github.event.schedule == '0 2 * * *' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'chaos'))

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: sark
          POSTGRES_PASSWORD: sark_test_password
          POSTGRES_DB: sark_test
        ports:
          - 5432:5432

      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -e ".[dev]"

      - name: Run chaos tests
        env:
          DATABASE_URL: postgresql://sark:sark_test_password@localhost:5432/sark_test
          REDIS_URL: redis://localhost:6379/0
        run: |
          pytest tests/chaos/gateway/ \
            -m chaos \
            -v \
            --tb=short

      - name: Upload chaos test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: chaos-test-results
          path: test-results/

  # ============================================================================
  # JOB 6: TEST RESULTS SUMMARY
  # ============================================================================
  test-summary:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## Gateway Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.unit-tests.result }}" == "success" ]; then
            echo "✅ Unit Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Unit Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "✅ Integration Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Integration Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if critical tests failed
        if: |
          needs.unit-tests.result == 'failure' ||
          needs.integration-tests.result == 'failure'
        run: |
          echo "::error::Critical tests failed"
          exit 1

  # ============================================================================
  # JOB 7: NOTIFY ON FAILURE
  # ============================================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, performance-tests, security-tests]
    if: failure()

    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Gateway Tests Failed - ' + context.sha.substring(0, 7),
              body: 'Gateway test suite failed. Check workflow run: ' + context.serverUrl + '/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId,
              labels: ['testing', 'gateway', 'ci-failure']
            })
